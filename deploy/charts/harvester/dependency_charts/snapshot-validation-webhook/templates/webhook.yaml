---
{{- $certificate := "" }}
{{- $key := "" }}
{{- if .Values.webhook.tls.autoGenerated }}
  {{- $serviceName := (printf "%s.%s.svc" (include "snapshot-validation-webhook.fullname" .) (include "snapshot-validation-webhook.namespace" .))  }}
  {{- $cert := genSelfSignedCert $serviceName nil (list $serviceName) 3650 }}
  {{- $certificate = b64enc $cert.Cert }}
  {{- $key = b64enc $cert.Key }}
{{- else }}
  {{- $certificate = b64enc .Values.webhook.tls.certificate }}
  {{- $key = b64enc .Values.webhook.tls.key }}
{{- end }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Values.webhook.tls.secretName }}
  namespace: {{ include "snapshot-validation-webhook.namespace" . }}
type: kubernetes.io/tls
data:
  ca.crt: {{ $certificate }}
  tls.crt: {{ $certificate }}
  tls.key: {{ $key }}
---
apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingWebhookConfiguration
metadata:
  name: {{ include "snapshot-validation-webhook.fullname" . }}
  labels: {{ include "snapshot-validation-webhook.labels" . | nindent 4 }}
webhooks:
  - name: {{ include "snapshot-validation-webhook.name" . }}.csi.kubernetes.io
    rules:
      - apiGroups:   ["snapshot.storage.k8s.io"]
        apiVersions: ["v1", "v1beta1"]
        operations:  ["CREATE", "UPDATE"]
        resources:   ["volumesnapshots", "volumesnapshotcontents"]
        scope:       "*"
    clientConfig:
      service:
        namespace: {{ include "snapshot-validation-webhook.namespace" . }}
        name: {{ include "snapshot-validation-webhook.fullname" . }}
        path: "/volumesnapshot"
      caBundle: {{ $certificate }}
    admissionReviewVersions: ["v1", "v1beta1"]
    sideEffects: None
    failurePolicy: {{ .Values.webhook.failurePolicy }}
    timeoutSeconds: {{ .Values.webhook.timeoutSeconds }}
